<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Secured SFTP setup</title><style>html body{font-family:raleway,sans-serif;background-color:#656565}:root{--accent: #cc9933;--border-width:  5px }</style><link rel=stylesheet href=https://www.vincent-gou.fr/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.78.2"></head><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><body><a class=flagselect href=/en/post/security_sftp_and_chroot_config/>enðŸ‡¬ðŸ‡§</a>
<a class=flagnoselect href=/post/security_sftp_and_chroot_config/>frðŸ‡«ðŸ‡·</a><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>Secured SFTP setup</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/project/>Projects</a></li><li><a href=/post/>Articles</a></li><li><a href=/tags/>Tags</a></li><li><a href=/calendar/>Calendar</a></li></ul></div></div></nav><div class=page_info><h4 class=page_info>Translation available:</h4><a href=https://www.vincent-gou.fr/post/security_sftp_and_chroot_config/ class=page_info><b>fr</b> ParamÃ©trage SFTP sÃ©curisÃ© complet /</a></div><h4 class=page_info></h4><h6 class=page_info></br>5 minutes read time</h6><main><div class=item><h4><a href=/en/post/security_sftp_and_chroot_config/>Secured SFTP setup</a></h4><h5>May 11, 2020</h5><a href=https://www.vincent-gou.frtags/sftp><kbd class=item-tag>sftp</kbd></a>
<a href=https://www.vincent-gou.frtags/linux><kbd class=item-tag>linux</kbd></a>
<a href=https://www.vincent-gou.frtags/securite><kbd class=item-tag>securite</kbd></a></div><br><div class=text-justify><div class=sect1><h2 id=_objectives>Objectives</h2><div class=sectionbody><div class=ulist><ul><li><p>Deliver secured resources access to a Linux server through SFTP.</p></li><li><p>SFTP accounts will only have access to allowed resource.</p></li><li><p>An administrator account will be able to manage user accounts.</p></li></ul></div></div></div><div class=sect1><h2 id=_target_user_mode_diagram>Target User mode diagram</h2><div class=sectionbody><div class=imageblock><div class=content><svg viewBox="0 0 640 360" xmlns="http://www.w3.org/2000/svg" xmlns:inkspace="http://www.inkscape.org/namespaces/inkscape" xmlns:xlink="http://www.w3.org/1999/xlink" width="640" height="360"><defs id="defs_block"><filter height="1.504" id="filter_blur" inkspace:collect="always" width="1.1575" x="-.07875" y="-.252"><feGaussianBlur id="feGaussianBlur3780" inkspace:collect="always" stdDeviation="4.2"/></filter></defs><title>blockdiag</title><desc>blockdiag { default_shape = roundedbox; // Set labels to nodes. A1 [shape =
actor,label = "USER1", numbered = 1]; B [label = "SSHD", numbered = 2]; C
[label = "SSHD_CONFIG", numbered = 3]; D [label = "/data/sftp_group_1/USER1"
, numbered = 4]; E [label = "UMASK 0007" , numbered = 5]; F [label =
"Default Folder /upload under chroot", numbered = 6]; // Set labels to
edges. (short text only) A1 -> B [label = "SFTP"]; B &lt;- C [label =
"read"]; B -> D [label = "chroot"]; B -> E [label = "set"]; B -> F
[label = "move"]; group { label = "SSHD Match Group"; orientation = portrait
D -> E -> F; } }</desc><rect fill="rgb(243,152,0)" height="220" style="filter:url(#filter_blur)" width="144" x="440" y="110"/><polygon fill="rgb(0,0,0)" points="133,60 133,63 143,63 143,66 133,66 133,69 141,78 137,78 131,72 125,78 121,78 129,69 129,66 119,66 119,63 129,63 129,60" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><ellipse cx="131" cy="57" fill="rgb(0,0,0)" rx="4" ry="4" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M267 46H379a8 8 0 018 8V78a8 8 0 01-8 8H267a8 8 0 01-8-8V54a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 46H571a8 8 0 018 8V78a8 8 0 01-8 8H459a8 8 0 01-8-8V54a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 126H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V134a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 206H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V214a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 286H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V294a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><polygon fill="rgb(255,255,255)" points="130,54 130,57 140,57 140,60 130,60 130,63 138,72 134,72 128,66 122,72 118,72 126,63 126,60 116,60 116,57 126,57 126,54" stroke="rgb(0,0,0)"/><ellipse cx="128" cy="51" fill="rgb(255,255,255)" rx="4" ry="4" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="30" x="128" y="85">USER1</text><ellipse cx="64" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="64" y="46">1</text><path d="M264 40H376a8 8 0 018 8V72a8 8 0 01-8 8H264a8 8 0 01-8-8V48a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="320" y="66">SSHD</text><ellipse cx="256" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="256" y="46">2</text><path d="M456 40H568a8 8 0 018 8V72a8 8 0 01-8 8H456a8 8 0 01-8-8V48a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="66" x="512" y="66">SSHD_CONFIG</text><ellipse cx="448" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="46">3</text><path d="M456 120H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V128a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="126" x="512" y="139">/data/sftp_group_1/US</text><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="18" x="512" y="152">ER1</text><ellipse cx="448" cy="120" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="126">4</text><path d="M456 2e2H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V208a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="60" x="512" y="226">UMASK 0007</text><ellipse cx="448" cy="200" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="206">5</text><path d="M456 280H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V288a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="126" x="512" y="299">Default Folder /uploa</text><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="84" x="512" y="312">d under chroot</text><ellipse cx="448" cy="280" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="286">6</text><path d="M140 60H248" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="255,60 248,56 248,64 255,60" stroke="rgb(0,0,0)"/><path d="M392 60h56" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="385,60 392,56 392,64 385,60" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60v80" fill="none" stroke="rgb(0,0,0)"/><path d="M416 140h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,140 440,136 440,144 447,140" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60V220" fill="none" stroke="rgb(0,0,0)"/><path d="M416 220h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,220 440,216 440,224 447,220" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60V3e2" fill="none" stroke="rgb(0,0,0)"/><path d="M416 3e2h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,300 440,296 440,304 447,300" stroke="rgb(0,0,0)"/><path d="M512 160v32" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="512,199 508,192 516,192 512,199" stroke="rgb(0,0,0)"/><path d="M512 240v32" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="512,279 508,272 516,272 512,279" stroke="rgb(0,0,0)"/><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="204" y="38"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="224" y="51">SFTP</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="396" y="38"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="416" y="51">read</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="52" x="390" y="118"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="36" x="416" y="131">chroot</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="34" x="399" y="198"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="18" x="416" y="211">set</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="396" y="278"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="416" y="291">move</text><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="96" x="512" y="116">SSHD Match Group</text></svg></div></div></div></div><div class=sect1><h2 id=_target_admin_mode_diagram>Target Admin mode diagram</h2><div class=sectionbody><div class=imageblock><div class=content><svg viewBox="0 0 640 440" xmlns="http://www.w3.org/2000/svg" xmlns:inkspace="http://www.inkscape.org/namespaces/inkscape" xmlns:xlink="http://www.w3.org/1999/xlink" width="640" height="440"><defs id="defs_block"><filter height="1.504" id="filter_blur" inkspace:collect="always" width="1.1575" x="-.07875" y="-.252"><feGaussianBlur id="feGaussianBlur3780" inkspace:collect="always" stdDeviation="4.2"/></filter></defs><title>blockdiag</title><desc>blockdiag { default_shape = roundedbox; // Set labels to nodes. A1 [shape =
actor,label = "USER1", numbered = 1]; A2 [shape = actor,label = "USER2",
numbered = 1]; B [label = "SSHD", numbered = 2]; C [label = "SSHD_CONFIG",
numbered = 3]; D [label = "/data/sftp_group_1/%u" , numbered = 4]; E [label
= "UMASK 0007" , numbered = 5]; F [label = "Default Folder /upload under
chroot", numbered = 6]; // Set labels to edges. (short text only) A1 -> B
[label = "SFTP"]; A2 -> B [label = "SFTP"]; B &lt;- C [label = "read"]; B
-> D [label = "chroot"]; B -> E [label = "set"]; B -> F [label =
"move"]; group { label = "SSHD Match Group"; orientation = portrait D ->
E -> F; } }</desc><rect fill="rgb(243,152,0)" height="220" style="filter:url(#filter_blur)" width="144" x="440" y="110"/><polygon fill="rgb(0,0,0)" points="133,60 133,63 143,63 143,66 133,66 133,69 141,78 137,78 131,72 125,78 121,78 129,69 129,66 119,66 119,63 129,63 129,60" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><ellipse cx="131" cy="57" fill="rgb(0,0,0)" rx="4" ry="4" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><polygon fill="rgb(0,0,0)" points="133,380 133,383 143,383 143,386 133,386 133,389 141,398 137,398 131,392 125,398 121,398 129,389 129,386 119,386 119,383 129,383 129,380" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><ellipse cx="131" cy="377" fill="rgb(0,0,0)" rx="4" ry="4" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M267 46H379a8 8 0 018 8V78a8 8 0 01-8 8H267a8 8 0 01-8-8V54a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 46H571a8 8 0 018 8V78a8 8 0 01-8 8H459a8 8 0 01-8-8V54a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 126H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V134a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 206H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V214a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><path d="M459 286H571a8 8 0 018 8v24a8 8 0 01-8 8H459a8 8 0 01-8-8V294a8 8 0 018-8" fill="rgb(0,0,0)" stroke="rgb(0,0,0)" style="filter:url(#filter_blur);opacity:.7;fill-opacity:1"/><polygon fill="rgb(255,255,255)" points="130,54 130,57 140,57 140,60 130,60 130,63 138,72 134,72 128,66 122,72 118,72 126,63 126,60 116,60 116,57 126,57 126,54" stroke="rgb(0,0,0)"/><ellipse cx="128" cy="51" fill="rgb(255,255,255)" rx="4" ry="4" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="30" x="128" y="85">USER1</text><ellipse cx="64" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="64" y="46">1</text><polygon fill="rgb(255,255,255)" points="130,374 130,377 140,377 140,380 130,380 130,383 138,392 134,392 128,386 122,392 118,392 126,383 126,380 116,380 116,377 126,377 126,374" stroke="rgb(0,0,0)"/><ellipse cx="128" cy="371" fill="rgb(255,255,255)" rx="4" ry="4" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="30" x="128" y="405">USER2</text><ellipse cx="64" cy="360" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="64" y="366">1</text><path d="M264 40H376a8 8 0 018 8V72a8 8 0 01-8 8H264a8 8 0 01-8-8V48a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="320" y="66">SSHD</text><ellipse cx="256" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="256" y="46">2</text><path d="M456 40H568a8 8 0 018 8V72a8 8 0 01-8 8H456a8 8 0 01-8-8V48a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="66" x="512" y="66">SSHD_CONFIG</text><ellipse cx="448" cy="40" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="46">3</text><path d="M456 120H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V128a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="126" x="512" y="146">/data/sftp_group_1/%u</text><ellipse cx="448" cy="120" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="126">4</text><path d="M456 2e2H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V208a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="60" x="512" y="226">UMASK 0007</text><ellipse cx="448" cy="200" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="206">5</text><path d="M456 280H568a8 8 0 018 8v24a8 8 0 01-8 8H456a8 8 0 01-8-8V288a8 8 0 018-8" fill="rgb(255,255,255)" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="126" x="512" y="299">Default Folder /uploa</text><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="84" x="512" y="312">d under chroot</text><ellipse cx="448" cy="280" fill="pink" rx="12" ry="12" stroke="rgb(0,0,0)"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="6" x="448" y="286">6</text><path d="M140 60H248" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="255,60 248,56 248,64 255,60" stroke="rgb(0,0,0)"/><path d="M140 380H240" fill="none" stroke="rgb(0,0,0)"/><path d="M240 380V60" fill="none" stroke="rgb(0,0,0)"/><path d="M240 60h8" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="255,60 248,56 248,64 255,60" stroke="rgb(0,0,0)"/><path d="M392 60h56" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="385,60 392,56 392,64 385,60" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60v80" fill="none" stroke="rgb(0,0,0)"/><path d="M416 140h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,140 440,136 440,144 447,140" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60V220" fill="none" stroke="rgb(0,0,0)"/><path d="M416 220h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,220 440,216 440,224 447,220" stroke="rgb(0,0,0)"/><path d="M384 60h32" fill="none" stroke="rgb(0,0,0)"/><path d="M416 60V3e2" fill="none" stroke="rgb(0,0,0)"/><path d="M416 3e2h24" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="447,300 440,296 440,304 447,300" stroke="rgb(0,0,0)"/><path d="M512 160v32" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="512,199 508,192 516,192 512,199" stroke="rgb(0,0,0)"/><path d="M512 240v32" fill="none" stroke="rgb(0,0,0)"/><polygon fill="rgb(0,0,0)" points="512,279 508,272 516,272 512,279" stroke="rgb(0,0,0)"/><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="204" y="38"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="224" y="51">SFTP</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="204" y="343"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="224" y="356">SFTP</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="396" y="38"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="416" y="51">read</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="52" x="390" y="118"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="36" x="416" y="131">chroot</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="34" x="399" y="198"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="18" x="416" y="211">set</text><rect fill="#fff" height="15" stroke="rgb(0,0,0)" width="40" x="396" y="278"/><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="24" x="416" y="291">move</text><text fill="rgb(0,0,0)" font-family="sans-serif" font-size="11" font-style="normal" font-weight="normal" text-anchor="middle" textLength="96" x="512" y="116">SSHD Match Group</text></svg></div></div></div></div><div class=sect1><h2 id=_controls>Controls</h2><div class=sectionbody><div class=sect2><h3 id=_sftp_activation_in_sshd_control>SFTP activation in SSHD control</h3><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>[root@server /]# cat /etc/ssh/sshd_config
....
# override default of no subsystems
Subsystem      sftp    /usr/libexec/openssh/sftp-server</code></pre></div></div></div></div></div><div class=sect1><h2 id=_directory_tree_creation>Directory tree creation</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>mkdir -p /directory
chmod 700 /directory</code></pre></div></div><div class=paragraph><p>Example:</p></div><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>[root@server /]# mkdir -p /data/sftp_group_1
[root@server /]# chmod 700 /data</code></pre></div></div></div></div><div class=sect1><h2 id=_sftp_user_and_group_creation>SFTP user and group creation</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>groupadd sftp_group_1 // <b class=conum>(1)</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER1 // <b class=conum>(2)</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER2 // <b class=conum>(3)</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER3 // <b class=conum>(4)</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER4 // <b class=conum>(5)</b></code></pre></div></div><div class="colist arabic"><ol><li><p>User created group name ownership.</p></li><li><p>-g : Ownership group for user USER1 / -d Profil path / -s connxion shell â‡’ none</p></li><li><p>-g : Ownership group for user USER2 / -d Profil path / -s connxion shell â‡’ none</p></li><li><p>-g : Ownership group for user USER3 / -d Profil path / -s connxion shell â‡’ none</p></li><li><p>-g : Ownership group for user USER4 / -d Profil path / -s connxion shell â‡’ none</p></li></ol></div></div></div><div class=sect1><h2 id=_created_user_password_setup>Created user password setup</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>passwd USER1
passwd USER2
passwd USER3
passwd USER4</code></pre></div></div></div></div><div class=sect1><h2 id=_sftp_user_config_file_check_up>SFTP user config file check-up</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>cat /etc/passwd
....
USER1:x:1002:1002::/:/sbin/nologin
USER2:x:1003:1002::/:/sbin/nologin
USER3:x:1004:1002::/:/sbin/nologin
USER4:x:1005:1002::/:/sbin/nologin</code></pre></div></div></div></div><div class=sect1><h2 id=_user_defauklt_directory_tree_creation>User defauklt directory tree creation</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>mkdir -p /data/sftp_group_1/USER2/upload // <b class=conum>(1)</b>
chown -R root:root /data/sftp_group_1/USER2 // <b class=conum>(2)</b>
chown -R USER2:sftp_users /data/sftp_group_1/USER2/upload // <b class=conum>(3)</b>
chmod 770 /data/sftp_group_1/USER2/upload // <b class=conum>(4)</b>

mkdir -p /data/sftp_group_1/USER1/upload // <b class=conum>(1)</b>
chown -R root:root /data/sftp_group_1/USER1 // <b class=conum>(2)</b>
chown -R USER1:sftp_users /data/sftp_group_1/USER1/upload // <b class=conum>(3)</b>
chmod 770 /data/sftp_group_1/USER1/upload // <b class=conum>(4)</b>

mkdir -p /data/sftp_group_1/USER3/upload // <b class=conum>(1)</b>
chown -R root:root /data/sftp_group_1/USER3 // <b class=conum>(2)</b>
chown -R USER3:sftp_users /data/sftp_group_1/USER3/upload // <b class=conum>(3)</b>
chmod 770 /data/sftp_group_1/USER3/upload // <b class=conum>(4)</b>

mkdir -p /data/sftp_group_1/USER4/upload // <b class=conum>(1)</b>
chown -R root:root /data/sftp_group_1/USER4 // <b class=conum>(2)</b>
chown -R USER4:sftp_users /data/sftp_group_1/USER4/upload // <b class=conum>(3)</b>
chmod 770 /data/sftp_group_1/USER4/upload // <b class=conum>(4)</b></code></pre></div></div><div class="colist arabic"><ol><li><p>User home directory creation, accessibilty R/W.</p></li><li><p>Rights setup to <strong><em>root:root</em></strong> on chrooted user root folder.</p></li><li><p>Rights setup to <strong><em>$COMPTE$:sftp_users</em></strong> on chrooted user folder.</p></li><li><p>Affectation des droits au rÃ©pertoire Ã  lâ€™utilisateur et au groupe dâ€™appartenance dans lequel lâ€™utilisateur associÃ© Ã  la sociÃ©tÃ© pourra lire et Ã©crire.</p></li></ol></div></div></div><div class=sect1><h2 id=_sftp_admin_account_setup>SFTP Admin account setup</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>[root@server sftp]# useradd -g sftp_users -d / -s /sbin/nologin SFTP_ADM // <b class=conum>(1)</b>
[root@server sftp]# cat /etc/passwd
...
SFTP_ADM:x:1006:1002::/:/sbin/nologin</code></pre></div></div><div class="colist arabic"><ol><li><p>-g : Groupe dâ€™appartenance du compte SFTP_ADM / -d Chemin du profil / -s shell de connxion â‡’ aucun</p></li></ol></div></div></div><div class=sect1><h2 id=_sshd_setup>SSHD setup</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>[root@server sftp]# cp -p /etc/ssh/sshd_config /etc/ssh/sshd_config.sav
[root@server sftp]# vi /etc/ssh/sshd_config
# override default of no subsystems
#Subsystem      sftp    /usr/libexec/openssh/sftp-server // <b class=conum>(1)</b>
## Add umask to U+G none to Others
Subsystem sftp internal-sftp -u 0007 // <b class=conum>(2)</b>
IgnoreRhosts yes
IgnoreUserKnownHosts no
PrintMotd yes
StrictModes yes
PubkeyAuthentication yes
#RSAAuthentication yes
PermitRootLogin no
PermitEmptyPasswords no

# Example of overriding settings on a per-user basis
#Match User anoncvs
#       X11Forwarding no
#       AllowTcpForwarding no
#       PermitTTY no
#       ForceCommand cvs server

# A placer avant le test sur le groupe si le user appartient au groupe sftp_users
# SSHD lit la config dans l&#39;ordre d apparition....
Match User SFTP_ADM // <b class=conum>(3)</b>
ChrootDirectory /data/sftp_group_1 // <b class=conum>(4)</b>
## Add umask to U+G none to Others
ForceCommand internal-sftp -u 0007 // <b class=conum>(5)</b>

Match Group sftp_users // <b class=conum>(6)</b>
ChrootDirectory /data/sftp/%u // <b class=conum>(7)</b>
## Add umask to U+G none to Others
ForceCommand internal-sftp -u 0007 -d /upload // <b class=conum>(8)</b></code></pre></div></div><div class="colist arabic"><ol><li><p>DÃ©sactivation server SFTP par dÃ©faut</p></li><li><p>Activation serveur SFTP intÃ©grÃ© Ã  sshd</p></li><li><p>Bloc concernant le compte SFTP_ADM</p></li><li><p>Chroot du compte <strong><em>SFTP_ADM</em></strong> vers /data/sftp_group_1</p></li><li><p>Obligation du SFTP uniquement et changement du UMASK vers 0007 (correspond Ã  770)</p></li><li><p>Bloc concernant les membres du groupe <strong><em>sftp_users</em></strong></p></li><li><p>Chroot des membres du groupe <strong><em>sftp_users</em></strong> vers /data/sftp/%u (%u est une variable pour le nom dâ€™utilisateur)</p></li><li><p>Obligation du SFTP uniquement et changement du UMASK vers 0007 (correspond Ã  770) et dÃ©placement automatique dans le rÃ©pertoire upload</p></li></ol></div></div></div><div class=sect1><h2 id=_sshd_restart_and_controls>SSHD restart and controls</h2><div class=sectionbody><div class=listingblock><div class=content><pre class=highlight><code class=language-bash data-lang=bash>systemctl restart sshd
systemctl status sshd</code></pre></div></div></div></div></div><h4 class=page-header>Author:</h4><figure><img class=avatar src=../../../images/vincent.en.png alt><figcaption><a href=https://www.vincent-gou.fr/en/authors/vincent-gourrierec/>Vincent Gourrierec</a></figcaption></figure></main><footer><p class="copyright text-muted">2020 - Â© All rights reserved. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/calintat/minimal>Minimal</a> theme and [Vincent Gourrierec] (<a href=https://www.vincent-gou.fr>https://www.vincent-gou.fr</a>)</p></footer></body></html>