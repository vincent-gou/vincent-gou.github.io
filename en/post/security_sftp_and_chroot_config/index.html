<!doctype html><html lang=fr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Secured SFTP setup</title><style>html body{font-family:raleway,sans-serif;background-color:#656565}:root{--accent: #cc9933;--border-width:  5px }</style><link rel=stylesheet href=https://vincent-gou.github.io/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Raleway"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link rel=stylesheet href=https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css integrity=sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js></script><script>hljs.initHighlightingOnLoad();</script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js></script><script src=https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script>$(document).on('click',function(){$('.collapse').collapse('hide');})</script><meta name=generator content="Hugo 0.78.2"></head><script type=text/javascript async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><body><a class=flagselect href=/en/post/security_sftp_and_chroot_config/>enðŸ‡¬ðŸ‡§</a>
<a class=flagnoselect href=/post/security_sftp_and_chroot_config/>frðŸ‡«ðŸ‡·</a><nav class="navbar navbar-default navbar-fixed-top"><div class=container><div class=navbar-header><a class="navbar-brand visible-xs" href=#>Secured SFTP setup</a>
<button class=navbar-toggle data-target=.navbar-collapse data-toggle=collapse>
<span class=icon-bar></span><span class=icon-bar></span><span class=icon-bar></span></button></div><div class="collapse navbar-collapse"><ul class="nav navbar-nav"><li><a href=/>Home</a></li><li><a href=/project/>Projects</a></li><li><a href=/post/>Articles</a></li><li><a href=/tags/>Tags</a></li><li><a href=/calendar/>Calendar</a></li></ul></div></div></nav><div class=page_info><h4 class=page_info>Translation available:</h4><a href=https://vincent-gou.github.io/post/security_sftp_and_chroot_config/ class=page_info><b>fr</b> ParamÃ©trage SFTP sÃ©curisÃ© complet /</a></div><h4 class=page_info></h4><h6 class=page_info></br>3 minutes read time</h6><main><div class=item><h4><a href=/en/post/security_sftp_and_chroot_config/>Secured SFTP setup</a></h4><h5>May 11, 2020</h5><a href=https://vincent-gou.github.io/tags/sftp><kbd class=item-tag>sftp</kbd></a>
<a href=https://vincent-gou.github.io/tags/linux><kbd class=item-tag>linux</kbd></a>
<a href=https://vincent-gou.github.io/tags/securite><kbd class=item-tag>securite</kbd></a></div><br><div class=text-justify><section class="doc-section level-1"><h2 id=_objectives>Objectives</h2><div class=ulist><ul><li>Deliver secured resources access to a Linux server through SFTP.</li><li>SFTP accounts will only have access to allowed resource.</li><li>An administrator account will be able to manage user accounts.</li></ul></div></section><section class="doc-section level-1"><h2 id=_target_user_mode_diagram>Target User mode diagram</h2><div class=image-block><img src=images/sftp_user_mode_en.svg alt="sftp user mode en" width=640 height=360></div></section><section class="doc-section level-1"><h2 id=_target_admin_mode_diagram>Target Admin mode diagram</h2><div class=image-block><img src=images/sftp_admin_mode_en.svg alt="sftp admin mode en" width=640 height=440></div></section><section class="doc-section level-1"><h2 id=_controls>Controls</h2><section class="doc-section level-2"><h3 id=_sftp_activation_in_sshd_control>SFTP activation in SSHD control</h3><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>[root@server /]# cat /etc/ssh/sshd_config
....
# override default of no subsystems
Subsystem      sftp    /usr/libexec/openssh/sftp-server</code></pre></div></section></section><section class="doc-section level-1"><h2 id=_directory_tree_creation>Directory tree creation</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>mkdir -p /directory
chmod 700 /directory</code></pre></div><p>Example:</p><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>[root@server /]# mkdir -p /data/sftp_group_1
[root@server /]# chmod 700 /data</code></pre></div></section><section class="doc-section level-1"><h2 id=_sftp_user_and_group_creation>SFTP user and group creation</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>groupadd sftp_group_1 <b class=conum>1</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER1 <b class=conum>2</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER2 <b class=conum>3</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER3 <b class=conum>4</b>
useradd -g sftp_group_1 -d / -s /sbin/nologin USER4 <b class=conum>5</b></code></pre><ol class="callout-list arabic"><li>User created group name ownership.</li><li>-g : Ownership group for user USER1 / -d Profil path / -s connxion shell â‡’ none</li><li>-g : Ownership group for user USER2 / -d Profil path / -s connxion shell â‡’ none</li><li>-g : Ownership group for user USER3 / -d Profil path / -s connxion shell â‡’ none</li><li>-g : Ownership group for user USER4 / -d Profil path / -s connxion shell â‡’ none</li></ol></div></section><section class="doc-section level-1"><h2 id=_created_user_password_setup>Created user password setup</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>passwd USER1
passwd USER2
passwd USER3
passwd USER4</code></pre></div></section><section class="doc-section level-1"><h2 id=_sftp_user_config_file_check_up>SFTP user config file check-up</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>cat /etc/passwd
....
USER1:x:1002:1002::/:/sbin/nologin
USER2:x:1003:1002::/:/sbin/nologin
USER3:x:1004:1002::/:/sbin/nologin
USER4:x:1005:1002::/:/sbin/nologin</code></pre></div></section><section class="doc-section level-1"><h2 id=_user_defauklt_directory_tree_creation>User defauklt directory tree creation</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>mkdir -p /data/sftp_group_1/USER2/upload <b class=conum>1</b>
chown -R root:root /data/sftp_group_1/USER2 <b class=conum>2</b>
chown -R USER2:sftp_users /data/sftp_group_1/USER2/upload <b class=conum>3</b>
chmod 770 /data/sftp_group_1/USER2/upload <b class=conum>4</b>

mkdir -p /data/sftp_group_1/USER1/upload <b class=conum>1</b>
chown -R root:root /data/sftp_group_1/USER1 <b class=conum>2</b>
chown -R USER1:sftp_users /data/sftp_group_1/USER1/upload <b class=conum>3</b>
chmod 770 /data/sftp_group_1/USER1/upload <b class=conum>4</b>

mkdir -p /data/sftp_group_1/USER3/upload <b class=conum>1</b>
chown -R root:root /data/sftp_group_1/USER3 <b class=conum>2</b>
chown -R USER3:sftp_users /data/sftp_group_1/USER3/upload <b class=conum>3</b>
chmod 770 /data/sftp_group_1/USER3/upload <b class=conum>4</b>

mkdir -p /data/sftp_group_1/USER4/upload <b class=conum>1</b>
chown -R root:root /data/sftp_group_1/USER4 <b class=conum>2</b>
chown -R USER4:sftp_users /data/sftp_group_1/USER4/upload <b class=conum>3</b>
chmod 770 /data/sftp_group_1/USER4/upload <b class=conum>4</b></code></pre><ol class="callout-list arabic"><li>User home directory creation, accessibilty R/W.</li><li>Rights setup to <strong><em>root:root</em></strong> on chrooted user root folder.</li><li>Rights setup to <strong><em>$COMPTE$:sftp_users</em></strong> on chrooted user folder.</li><li>Affectation des droits au rÃ©pertoire Ã  lâ€™utilisateur et au groupe dâ€™appartenance dans lequel lâ€™utilisateur associÃ© Ã  la sociÃ©tÃ© pourra lire et Ã©crire.</li></ol></div></section><section class="doc-section level-1"><h2 id=_sftp_admin_account_setup>SFTP Admin account setup</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>[root@server sftp]# useradd -g sftp_users -d / -s /sbin/nologin SFTP_ADM <b class=conum>1</b>
[root@server sftp]# cat /etc/passwd
...
SFTP_ADM:x:1006:1002::/:/sbin/nologin</code></pre><ol class="callout-list arabic"><li>-g : Groupe dâ€™appartenance du compte SFTP_ADM / -d Chemin du profil / -s shell de connxion â‡’ aucun</li></ol></div></section><section class="doc-section level-1"><h2 id=_sshd_setup>SSHD setup</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>[root@server sftp]# cp -p /etc/ssh/sshd_config /etc/ssh/sshd_config.sav
[root@server sftp]# vi /etc/ssh/sshd_config
# override default of no subsystems
#Subsystem      sftp    /usr/libexec/openssh/sftp-server <b class=conum>1</b>
## Add umask to U+G none to Others
Subsystem sftp internal-sftp -u 0007 <b class=conum>2</b>
IgnoreRhosts yes
IgnoreUserKnownHosts no
PrintMotd yes
StrictModes yes
PubkeyAuthentication yes
#RSAAuthentication yes
PermitRootLogin no
PermitEmptyPasswords no

# Example of overriding settings on a per-user basis
#Match User anoncvs
#       X11Forwarding no
#       AllowTcpForwarding no
#       PermitTTY no
#       ForceCommand cvs server

# A placer avant le test sur le groupe si le user appartient au groupe sftp_users
# SSHD lit la config dans l&#39;ordre d apparition....
Match User SFTP_ADM <b class=conum>3</b>
ChrootDirectory /data/sftp_group_1 <b class=conum>4</b>
## Add umask to U+G none to Others
ForceCommand internal-sftp -u 0007 <b class=conum>5</b>

Match Group sftp_users <b class=conum>6</b>
ChrootDirectory /data/sftp/%u <b class=conum>7</b>
## Add umask to U+G none to Others
ForceCommand internal-sftp -u 0007 -d /upload <b class=conum>8</b></code></pre><ol class="callout-list arabic"><li>DÃ©sactivation server SFTP par dÃ©faut</li><li>Activation serveur SFTP intÃ©grÃ© Ã  sshd</li><li>Bloc concernant le compte SFTP_ADM</li><li>Chroot du compte <strong><em>SFTP_ADM</em></strong> vers /data/sftp_group_1</li><li>Obligation du SFTP uniquement et changement du UMASK vers 0007 (correspond Ã  770)</li><li>Bloc concernant les membres du groupe <strong><em>sftp_users</em></strong></li><li>Chroot des membres du groupe <strong><em>sftp_users</em></strong> vers /data/sftp/%u (%u est une variable pour le nom dâ€™utilisateur)</li><li>Obligation du SFTP uniquement et changement du UMASK vers 0007 (correspond Ã  770) et dÃ©placement automatique dans le rÃ©pertoire upload</li></ol></div></section><section class="doc-section level-1"><h2 id=_sshd_restart_and_controls>SSHD restart and controls</h2><div class=listing-block><pre class=highlight><code class=language-bash data-lang=bash>systemctl restart sshd
systemctl status sshd</code></pre></div></section></div><h4 class=page-header>Author:</h4><figure><img class=avatar src=../../../images/vincent.en.png alt><figcaption><a href=https://vincent-gou.github.io/en/authors/vincent-gourrierec/>Vincent Gourrierec</a></figcaption></figure></main><footer><p class="copyright text-muted">2020 - Â© All rights reserved. Powered by <a href=https://gohugo.io>Hugo</a> and <a href=https://github.com/calintat/minimal>Minimal</a> theme and [Vincent Gourrierec] (<a href=https://vincent-gou.fr>https://vincent-gou.fr</a>)</p></footer></body></html>